# WORK ORDER: R013-M06 Host Join Handling + Session Channel

**Target Worker**: Backend
**Parent Branch**: `work/WO-R013`
**Worker Branch**: `work/WO-R013-backend`

**Required Skills**:
- `skill-supabase-realtime` — Session channel creation, message handling
- `skill-transport-abstraction` — ITransport compliance

**Antigravity ACK**: 2026-02-05 (Pre-WO Double-Check PASSED)

**CTO Escalation**: Not Required (Continuation of pre-approved M01-M14 flow)

---

## 0. TASK 0: Test Runner Setup (MANDATORY FIRST)

**Constraint**: M06 requires unit tests. Test runner must be configured before M06 code.

### 0.1 Install Vitest
```bash
npm install -D vitest
```

### 0.2 Add Scripts to package.json
```json
{
  "scripts": {
    "test": "vitest"
  }
}
```

### 0.3 Verify Existing Tests Run
```bash
npm test
# Should discover src/SimCore/__tests__/*.test.js
```

### 0.4 Acceptance Criteria (Task 0)
- [ ] `npm run` shows `test` script
- [ ] `npm test` executes without "script not found" error
- [ ] Existing tests discovered (even if some fail)

**Gate**: Task 0 must PASS before proceeding to M06 implementation.

---

## 1. Context

M05 implemented Guest discovery. M06 implements the Host-side join handling:
- Host creates session channel (`asterobia:session:{hostId}`)
- Host receives JOIN_REQ from Guest
- Host responds with JOIN_ACK (accept/reject)
- On accept: Host sends initial SNAPSHOT

**Key Antigravity Decisions**:
- **META-LAYER ONLY** — no SimCore.step execution
- **Channel**: `asterobia:session:{hostId}` (separate from lobby)
- **Slots**: 0 = Host, 1-3 = Guests
- **Reject Reasons**: `SESSION_FULL`, `VERSION_MISMATCH`
- **Snapshot**: Must be < 100KB, Guest applies immediately

---

## 2. In-Scope Files (Whitelist)

- `package.json` (MODIFY — Task 0: add vitest, test script)
- `src/SimCore/multiplayer/SessionManager.js` (MODIFY — M06 join handling)
- `src/SimCore/transport/SupabaseTransport.js` (MODIFY — if session channel methods needed)
- `src/SimCore/__tests__/sessionManager.join.test.js` (CREATE)

---

## 3. Strict Out-of-Scope (Blacklist)

- `src/Main.js` (Never touch entry point)
- INPUT_CMD / CMD_BATCH flow (M09 scope)
- SimLoop execution (M07 scope)
- UI components (M14 scope)
- Any SimCore state mutation during join

---

## 4. Acceptance Criteria ("Done When")

### 4.1 Task 0 — Test Runner
- [ ] `npm test` runs without error
- [ ] Existing tests discovered

### 4.2 Session Channel
- [ ] Host creates `asterobia:session:{hostId}` channel on `hostGame()`
- [ ] Host subscribes to session channel for JOIN_REQ messages
- [ ] Session channel is separate from lobby channel

### 4.3 JOIN_REQ Handling
- [ ] `_handleJoinReq(msg)` validates:
  - `msg.protocolVersion === PROTOCOL_VERSION` (reject if mismatch)
  - `msg.guestId` exists
  - `msg.guestName` exists
- [ ] Duplicate JOIN_REQ from same guestId is ignored (idempotent)
- [ ] If session full (4 players): reject with `SESSION_FULL`
- [ ] If version mismatch: reject with `VERSION_MISMATCH`

### 4.4 JOIN_ACK Response
- [ ] `sendJoinAck(guestId, accepted, slot?, reason?)` implemented
- [ ] On accept: slot assigned (1-3), player added to `state.players`
- [ ] On accept: initial SNAPSHOT sent to Guest
- [ ] On reject: reason included in JOIN_ACK

### 4.5 Message Schemas
```javascript
// JOIN_REQ (Guest → Host)
{
  type: 'JOIN_REQ',
  guestId: string,
  guestName: string,
  protocolVersion: '0.13.0',
  timestamp: number
}

// JOIN_ACK (Host → Guest)
{
  type: 'JOIN_ACK',
  accepted: boolean,
  slot?: number,        // 1-3 if accepted
  hostId: string,
  reason?: string,      // 'SESSION_FULL' | 'VERSION_MISMATCH' if rejected
  protocolVersion: '0.13.0',
  timestamp: number
}

// SNAPSHOT (Host → Guest, on accept)
{
  type: 'SNAPSHOT',
  simTick: number,
  state: object,        // serialized game state
  timestamp: number
}
```

### 4.6 Slot Assignment
- [ ] Host = slot 0 (assigned in hostGame)
- [ ] First Guest = slot 1, Second = slot 2, Third = slot 3
- [ ] `getNextAvailableSlot()` returns lowest available slot or null if full

### 4.7 Snapshot Serialization
- [ ] Use existing `serializeState()` from StateSurface
- [ ] Snapshot size < 100KB (warn if >80KB)
- [ ] Wrap serialization in try-catch, reject gracefully on failure

### 4.8 Determinism Constraints
- [ ] Join flow is META-LAYER — no SimCore.step() calls
- [ ] Host generates SeededRNG seed but does NOT advance state
- [ ] `state.players` is meta-game state, NOT in sim serialization

### 4.9 Idempotency
- [ ] Duplicate JOIN_REQ from same guestId → ignored (no error, no duplicate slot)
- [ ] `sendJoinAck()` safe to call multiple times (idempotent)

---

## 5. Performance Constraints

| Constraint | Value |
|------------|-------|
| Snapshot max size | 100KB (reject if exceeded) |
| Snapshot warn size | 80KB |
| No polling | Use Realtime events only |
| Guest retry interval | 2s |
| Guest timeout | 10s |

---

## 6. HU-TEST Gate (PRIMARY)

Full script: `docs/TEST_LOGS/HU-TEST-R013-M06-JOIN-FLOW.md`

**Quick verification**:
```
Tab A (Host): game.html?net=supabase&dev=1
Tab B (Guest): game.html?net=supabase&dev=1

// Tab A
await game.sessionManager.hostGame('M06-TestHost')

// Tab B
await game.sessionManager.startDiscovery()
// wait 5s
const hosts = game.sessionManager.getAvailableHosts()
await game.sessionManager.joinGame(hosts[0].hostId)

// Tab A: Verify
game.sessionManager.state.players  // Should show 2 players

// Tab B: Verify
game.sessionManager.state.mySlot   // Should be 1
```

---

## 7. Reference

- Spec: `docs/specs/R013_MULTIPLAYER_HANDSHAKE_HOST_AUTHORITY.md` Section 4
- Risk Assessment: `docs/review-notes/R013-M06-JOIN-FLOW-RISKS.md`
- HU-TEST: `docs/TEST_LOGS/HU-TEST-R013-M06-JOIN-FLOW.md`
- Dependencies: M05 (Guest Discovery) — VERIFIED
