# WORK ORDER: R013-M03 SessionManager Skeleton

**Target Worker**: Backend
**Parent Branch**: `work/WO-R013`
**Worker Branch**: `work/WO-R013-backend`

**CTO Escalation**: Not Required (Continuation of pre-approved M01/M02 flow)
**Escalation Triggers**:
- [ ] Spec Ambiguity
- [x] Architecture Change (Game.js modification - pre-acknowledged)
- [ ] Determinism Risk

## 1. Context
R013 needs a central coordinator class that orchestrates the handshake flow between Host and Guest. SessionManager will be the main entry point for all multiplayer operations, using MessageTypes (M01) and SessionState (M02) created previously.

## 2. In-Scope Files (Whitelist)
- `src/SimCore/multiplayer/SessionManager.js` (CREATE)
- `src/Core/Game.js` (MODIFY - add `this.sessionManager = new SessionManager(this)`)
- `src/SimCore/__tests__/sessionManager.test.js` (CREATE)

## 3. Strict Out-of-Scope (Blacklist)
- `src/Main.js` (Never touch entry point)
- `package.json` (No dependency changes)
- `src/SimCore/transport/SupabaseTransport.js` (M04 scope - do not modify yet)
- Lobby/announce logic (M04 scope)
- Join handling logic (M06 scope)

## 4. Acceptance Criteria ("Done When")
- [ ] `SessionManager.js` exports class with:
  - `constructor(game)` storing game reference
  - `state` property (SessionState instance)
  - `transport` property (null initially)
  - `setTransport(transport)` method
  - `hostGame(sessionName)` stub (returns Promise, sets role to HOST)
  - `joinGame(hostId)` stub (returns Promise, sets role to GUEST)
  - `leaveGame()` stub (resets state)
  - `onMessage(msg)` router stub
- [ ] `Game.js` creates SessionManager in constructor
- [ ] Unit tests pass: `npm test -- sessionManager`
- [ ] Linter is green
- [ ] No circular dependency issues

## 5. Antigravity Decision Log
**2026-02-04**: CTO Ping #1 APPROVED for M01-M03 flow. Game.js modification acknowledged.

## 6. Reference
- Spec: `docs/specs/R013_MULTIPLAYER_HANDSHAKE_HOST_AUTHORITY.md` Section 3 (Handshake Protocol)
- Tasklist: `docs/specs/R013_IMPLEMENTATION_TASKLIST.md` Section M03
- Dependencies: M01 (MessageTypes), M02 (SessionState) â€” COMPLETED
