# WORK ORDER: R013-M04 Host Lobby Channel + Announce

**Target Worker**: Backend
**Parent Branch**: `work/WO-R013`
**Worker Branch**: `work/WO-R013-backend`

**Required Skills**:
- `skill-supabase-realtime` — Channel operations, broadcastToChannel
- `skill-transport-abstraction` — ITransport compliance, InputFactory pattern

**CTO Escalation**: Not Required (Continuation of pre-approved flow)
**Escalation Triggers**:
- [ ] Spec Ambiguity
- [x] Architecture Change (SupabaseTransport modification - pre-acknowledged)
- [ ] Determinism Risk

## 1. Context
R013 requires Host clients to broadcast their availability via a lobby channel. This task extends SessionManager with actual lobby functionality and adds channel methods to SupabaseTransport. Host will join `asterobia:lobby` and broadcast `HOST_ANNOUNCE` every 5 seconds.

## 2. In-Scope Files (Whitelist)
- `src/SimCore/multiplayer/SessionManager.js` (MODIFY - add hostGame implementation)
- `src/SimCore/transport/SupabaseTransport.js` (MODIFY - add joinChannel, broadcastToChannel)
- `src/SimCore/__tests__/sessionManager.host.test.js` (CREATE)

## 3. Strict Out-of-Scope (Blacklist)
- `src/Main.js` (Never touch entry point)
- `package.json` (No dependency changes)
- Join handling logic (M06 scope)
- Guest discovery (M05 scope - but can reference pattern)
- UI components (M14 scope)

## 4. Acceptance Criteria ("Done When")
- [ ] `SupabaseTransport.joinChannel(channelName, callback)` implemented
- [ ] `SupabaseTransport.broadcastToChannel(channelName, msg)` implemented
- [ ] `SessionManager.hostGame(sessionName)` fully implemented:
  - Sets role to HOST
  - Sets hostId to game.clientId
  - Joins lobby channel `asterobia:lobby`
  - Starts announce interval (5000ms)
  - Sends immediate first announce
- [ ] `SessionManager.sendAnnounce()` broadcasts HOST_ANNOUNCE with all required fields
- [ ] `SessionManager.stopAnnouncing()` clears interval on leave
- [ ] Unit tests written for host flow
- [ ] Linter is green

## 5. Antigravity Decision Log
**2026-02-04**: CTO Ping #1 APPROVED for M01-M14 flow. SupabaseTransport modification acknowledged.

## 6. Reference
- Spec: `docs/specs/R013_MULTIPLAYER_HANDSHAKE_HOST_AUTHORITY.md` Section 3.2 (Host Discovery)
- Tasklist: `docs/specs/R013_IMPLEMENTATION_TASKLIST.md` Section M04
- Dependencies: M03 (SessionManager) — COMPLETED

## 7. Message Schema (from spec)
```json
{
  "type": "HOST_ANNOUNCE",
  "hostId": "uuid-string",
  "sessionName": "Adam's Game",
  "mapSeed": "asterobia-seed-12345",
  "simTick": 1042,
  "currentPlayers": 1,
  "maxPlayers": 4,
  "protocolVersion": "0.13.0",
  "timestamp": 1706700000000
}
```
