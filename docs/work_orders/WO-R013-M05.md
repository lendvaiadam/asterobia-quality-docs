# WORK ORDER: R013-M05 Guest Lobby Listen

**Target Worker**: Backend
**Parent Branch**: `work/WO-R013`
**Worker Branch**: `work/WO-R013-backend`

**Required Skills**:
- `skill-supabase-realtime` — Channel subscription, message handling
- `skill-transport-abstraction` — ITransport compliance

**Antigravity ACK**: 2026-02-04 (Pre-WO Double-Check PASSED)

**CTO Escalation**: Not Required (Continuation of pre-approved M01-M14 flow)

---

## 1. Context

M04 implemented Host-side lobby announce. M05 implements the Guest-side: listening to `asterobia:lobby` for HOST_ANNOUNCE messages, maintaining an `availableHosts` map, and exposing a getter for UI consumption.

**Key Antigravity Decisions**:
- Explicit `startDiscovery()`/`stopDiscovery()` (no auto-join)
- Lazy pruning inside `getAvailableHosts()` (no background timers)
- Store normalized `HostEntry` object, not raw message
- Strict protocol version validation
- `availableHosts` is **meta-game state** — must NOT touch SimCore

---

## 2. In-Scope Files (Whitelist)

- `src/SimCore/multiplayer/SessionManager.js` (MODIFY)
- `src/SimCore/multiplayer/HostEntry.js` (CREATE — optional, can inline)

---

## 3. Strict Out-of-Scope (Blacklist)

- `src/Main.js` (Never touch entry point)
- `package.json` (No dependency changes)
- UI components (M14 scope)
- JOIN_REQ logic (M06 scope)
- Any SimCore/CommandQueue/SimLoop references

---

## 4. Acceptance Criteria ("Done When")

### 4.1 Discovery Control
- [ ] `SessionManager.startDiscovery()` joins `asterobia:lobby` channel
- [ ] `SessionManager.stopDiscovery()` leaves lobby channel, clears `availableHosts`
- [ ] Discovery does NOT auto-start on construction
- [ ] `startDiscovery()` MUST be idempotent (no duplicate channel join, no leak if called twice)
- [ ] `stopDiscovery()` MUST be idempotent (safe no-op if discovery not running)

### 4.2 Host Announce Handling
- [ ] `_handleHostAnnounce(msg)` validates:
  - `msg.protocolVersion === PROTOCOL_VERSION` (drop if mismatch)
  - `msg.hostId` exists
  - `msg.sessionName` exists
- [ ] Valid messages update `availableHosts` Map with normalized `HostEntry`

### 4.3 HostEntry Shape
```javascript
{
  hostId: string,
  sessionName: string,
  playerCount: number,
  maxPlayers: number,
  mapSeed: string,
  lastSeenAt: number  // Date.now() timestamp
}
```

### 4.4 Getter with Lazy Pruning
- [ ] `getAvailableHosts()` returns array of `HostEntry` objects
- [ ] Before returning, prunes entries where `Date.now() - lastSeenAt > 15000`
- [ ] Max list size: 50 hosts (FIFO eviction if exceeded)

### 4.5 Determinism Constraints
- [ ] `availableHosts` is NOT referenced by SimCore, CommandQueue, or SimLoop
- [ ] `availableHosts` is NOT included in `toJSON()` or any state serialization
- [ ] Code comment documents: `// META-GAME STATE: Do not serialize`

---

## 5. Implementation Notes

### 5.1 Constants
```javascript
const STALE_HOST_TIMEOUT_MS = 15000;  // 3 missed announces
const MAX_AVAILABLE_HOSTS = 50;
```

### 5.2 startDiscovery() Flow
```javascript
async startDiscovery() {
  if (this._discoveryActive) return;
  if (!this.transport?.joinChannel) {
    console.warn('[SessionManager] No transport for discovery');
    return;
  }
  await this.transport.joinChannel(LOBBY_CHANNEL, (msg) => this.onMessage(msg));
  this._discoveryActive = true;
  console.log('[SessionManager] Discovery started');
}
```

### 5.3 stopDiscovery() Flow
```javascript
stopDiscovery() {
  if (!this._discoveryActive) return;
  this.transport?.leaveChannel?.(LOBBY_CHANNEL);
  this.availableHosts.clear();
  this._discoveryActive = false;
  console.log('[SessionManager] Discovery stopped');
}
```

### 5.4 Validation in _handleHostAnnounce()
```javascript
_handleHostAnnounce(msg) {
  // Strict protocol match
  if (msg.protocolVersion !== PROTOCOL_VERSION) return;
  if (!msg.hostId || !msg.sessionName) return;

  // Don't add self
  if (msg.hostId === this.game.clientId) return;

  // FIFO eviction if at max
  if (this.availableHosts.size >= MAX_AVAILABLE_HOSTS && !this.availableHosts.has(msg.hostId)) {
    const oldestKey = this.availableHosts.keys().next().value;
    this.availableHosts.delete(oldestKey);
  }

  // Store normalized entry
  this.availableHosts.set(msg.hostId, {
    hostId: msg.hostId,
    sessionName: msg.sessionName,
    playerCount: msg.currentPlayers ?? 1,
    maxPlayers: msg.maxPlayers ?? 4,
    mapSeed: msg.mapSeed ?? '',
    lastSeenAt: Date.now()
  });
}
```

---

## 6. HU-TEST Verification (Manual)

**Teszt celja**: Ellenorizni, hogy a Guest discovery mukodik.

### PRE
- Ket bongeszo tab nyitva (Tab A = Host, Tab B = Guest)
- Mindketto: `game.html?net=supabase&dev=1`

### STEPS
1. **Tab A**: `await game.sessionManager.hostGame('TestHost')`
2. **Tab B**: `await game.sessionManager.startDiscovery()`
3. **Tab B**: `game.sessionManager.getAvailableHosts()` — varj 5-10s
4. **Tab A**: Zard be a tabot
5. **Tab B**: Varj 15s, majd `game.sessionManager.getAvailableHosts()`

### EXPECTED
- Step 3: Returns array with 1 entry (TestHost)
- Step 5: Returns empty array (host pruned after 15s stale)

### QUICK PASS/FAIL
- **PASS**: Host megjelenik, majd eltűnik stale timeout utan
- **FAIL**: Host nem jelenik meg VAGY nem tunik el 15s utan

---

## 7. Reference

- Spec: `docs/specs/R013_MULTIPLAYER_HANDSHAKE_HOST_AUTHORITY.md` Section 3.2
- Tasklist: `docs/specs/R013_IMPLEMENTATION_TASKLIST.md` Section M05
- Dependencies: M04 (Host Announce) — COMPLETED
